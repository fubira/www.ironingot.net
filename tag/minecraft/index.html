<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Minecraft - Page 1 - ironingot.net</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="../../assets/css/screen.css?v=ac1c951ce2">
    <link rel="stylesheet" type="text/css" href="../../assets/fonts/font-awesome.css?v=ac1c951ce2">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="../../assets/js/jquery.ghostHunter.js?v=ac1c951ce2"></script>

    <link rel="canonical" href="index.html">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="ironingot.net">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Minecraft - Page 1 - ironingot.net">
    <meta property="og:url" content="https://www.ironingot.net/tag/minecraft/">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Minecraft - Page 1 - ironingot.net">
    <meta name="twitter:url" content="https://www.ironingot.net/tag/minecraft/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Series",
    "publisher": "ironingot.net",
    "url": "https://www.ironingot.net/tag/minecraft/",
    "name": "Minecraft"
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="ironingot.net" href="../../rss/index.html">
</head>
<body class="tag-template tag-minecraft">

<div id="page" class="hfeed site">

    <header id="masthead" class="site-header" role="banner">
        <div class="header-wrapper">
            <nav id="site-navigation" class="main-navigation" role="navigation">
                <button class="menu-toggle">Menu</button>
                <ul class="nav">
    <li class="nav-home" role="presentation"><a href="../../">HOME</a></li>
    <li class="nav-minecraft-server" role="presentation"><a href="../../minecraft-server/">Minecraft Server</a></li>
    <li class="nav-dynmap" role="presentation"><a href="http://dynmap.ironingot.net/">Dynmap</a></li>
    <li class="nav-plugins" role="presentation"><a href="../../plugins/">Plugins</a></li>
</ul>
            </nav><!-- #site-navigation -->

            <div id="site-search" class="header-search">
                <div class="header-search-form">
            <form class="search-form">
                <label>
                    <span class="screen-reader-text">Search archives</span>
                    <span class="search-icon">
                    <a href="index.html" class="search-toggle"><span class="screen-reader-text">Search</span></a>
                    </span>
                    <input type="search" id="search-field" class="search-field" placeholder="Search..." value="" name="s" title="Search...">
                </label>
                <input type="submit" class="search-submit" value="search">
            </form>
            </div><!-- #search -->
            </div><!-- #search -->

        </div><!-- .header-wrapper -->

        <!--
        <div class="header-image">
            
        </div>
        -->
        <!-- .header-image -->
    </header><!-- #masthead -->

    <div id="content" class="site-content">

    <div id="primary" class="content-area">
        <main id="main" class="site-main" role="main">
            <section id="results"></section>
                <script>
                    $("#search-field").ghostHunter({
                        results   : "#results"
                    });
                </script>

                

<header class="tag-archive-header">
    <h4><i class="fa fa-tag archive-title"></i><span class="tag-archive-header-name">Minecraft</span></h4>
</header>


<article id="post" class="post tag-minecraft hentry">
<div class="entry-meta">
    <div class="meta-date">08 May 2015</div>
    <div>on <a href="index.html">Minecraft</a></div>
</div>

<div class="content-wrapper">
	<header class="entry-header">
    	<h1 class="entry-title"><a href="../../spigot-1-8-3-hawkeye-issue/">Spigot 1.8.3 + Hawkeye issue</a></h1>
    </header>
    <div class="entry-content">
        <p>鯖をCraftBukkit 1.7.2 -&gt; Spigot 1.8.3 に変えてみたところ案の定いろいろ問題が出たけども、その中で最も危険だった問題点をメモしておく。</p>

<p>1.8.3 への移行直後、Spigot鯖とは別のネットワークに置いてあったMySQL鯖に対してHawkeyeがすごい勢いでクエリを投げはじめ、送りきれないQueueが大量に蓄積されていってサーバが非常に重くなる現象が発生、まともにゲームができなくなってしまった。</p>

<p>取り急ぎHawkeyeの接続先をSpigot鯖のローカルのMySQLに変えたのだけれども、その後しばらく運営していると、サーバの空き容量が激減していることに気づき、いろいろ調べた結果MySQLのデータベースがこんなんなっていた。</p>

<pre><code>root@nagato:/var/lib/mysql# ls -lah  
total 80G  
drwx------ 10 mysql mysql 4.0K May  7 17:47 .  
drwxr-xr-x 59 root  root  4.0K Nov  5  2014 ..  
-rw-rw----  1 mysql mysql  80G May  9 02:11 ibdata1
...
</code></pre>

<p><strong>3日前までは合計10MBも使っていなかったようなDBが80GBだと…!?</strong></p>

<p>中身を見ようにもselectするとOutOfMemoryになってしまうような状況なので、Hawkeyeの書き込み先tableを変えて数分動かしてみたところ、秒速3500行、時速にして1260万行のデータがMySQLに送られていることが判明。</p>

<pre><code>|   25077 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25078 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25079 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25080 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25081 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25082 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
|   25083 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
|   25084 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
...
</code></pre>

<p>これらのデータが何を意味しているかというと、こちら。</p>

<p><img src="../../content/images/2015/10/2015-05-09_02-27-12-1024x576.jpg" alt="ホッパー">
<img src="../../content/images/2015/10/2015-05-09_02-27-24-1024x576.jpg" alt="中身が詰まった"></p>

<p>接続先が一杯で内容物を移動できないホッパーのchest transaction(28)が大量に記録されていたのだった。1.8になってEventの挙動が変わったのか？</p>

<p>まあホッパー内にある(=運搬するような)アイテムの情報が重要である可能性はほぼないと考えられるので、ホッパーのログをfilterしてしまうことにした。</p>

<h3 id="">対策</h3>

<p>plugins/Hawkeye/config.yml のcontainedtransaction-filter: hopperの部分をfalseに書き換える。</p>

<pre><code>containertransaction-filter:  
  chest: true
  doublechest: true
  furnace: true
  dispenser: true
  hopper: false
  dropper: true
</code></pre>

<p>結果、Hawkeyeのデータ量は15分で800行ぐらい(秒速1行以下)となりました。
めでたしめでたし。</p>

<p>そして肥大化したDBだけが残った。</p>
    </div>
</div>

</article>


<article id="post" class="post tag-minecraft hentry">
<div class="entry-meta">
    <div class="meta-date">05 Dec 2014</div>
    <div>on <a href="index.html">Minecraft</a></div>
</div>

<div class="content-wrapper">
	<header class="entry-header">
    	<h1 class="entry-title"><a href="../../craftbukkit-1-8-memo/">CraftBukkit-1.8 memo</a></h1>
    </header>
    <div class="entry-content">
        <h2 id="bukkitcraftbukkitspigot">Bukkit/CraftBukkit/Spigot  </h2>

<p>Mojang配下の公式ではなく、Spigotチームが1.8対応を行ったBukkit/CraftBukkit。今のところ生成物は配布されていないので自力でビルドする必要がある。Java-SDK + gitの環境を整えてあれば java -jar BuildTools.jar で出来上がる。</p>

<p>公式のBukkitコミュニティで開発されたものでないため、今後どうなるかの見通しは不明。ただし公式のBukkitはそれ以上に不明。</p>

<hr>

<h4 id="">看板データの変換問題</h4>

<p>CraftBukkit 1.8より一部の内部データがJSON形式で保存されるようになっているが、1.8以前のワールドにおいて作成した看板の文字列にJSONのSyntaxが含まれていた場合、その文字が消えてしまう。 <br>
この時問題になるのが、LocketteプラグインでロックをしているワールドをCraftBukkit 1.8でロードすると、</p>

<p><strong>全てのロックチェストの看板の[ ]が消滅し、ロックが外れる</strong></p>

<p>という現象が発生する。</p>

<p><img src="../../content/images/2015/10/2014-12-06_04-22-32.jpg" alt="ロックが機能していない状態"></p>

<p>セキュリティ強制全解除というあまりにもあんまりな現象のため回避策を探したところ、以下のようにサーバjar起動時のオプションに -DconvertLegacySign=true を追加することで、読み込んだワールドの看板データを変換処理してくれる機能が存在しているのを発見。</p>

<p><code>$ java -Xmx1024M -Xms1024M -DconvertLegacySigns=true -jar craftbukkit.jar</code></p>

<p>変換と同時に看板の内部データに変換済みのフラグを埋め込むため、2重3重に変換がかかる心配はないが、1.8でこのフラグ無しですでに読み込んでしまったワールドは変換処理をせずJSON型で保存済みのため、その後 convertLegacySigns を有効にすると2重変換がかかり、下記のように看板の内容が破損する。</p>

<p><img src="/content/images/2015/10/2014-12-06_03-40-31.jpg" alt="空行が null になり、文章行は "></p>

<p>すでに1.8で起動してしまったワールドを今後も使いたい場合、後からconvertLegacySignsを設定するのはおすすめできない。泣きながらワールド中の看板を貼り直すことになる可能性が高い。</p>

<p><strong>そんな状況に陥らないためにもバックアップを忘れずに。</strong></p>

<p>※このフラグの情報が現状出てないのは、このようにワールドを壊す危険性が高いからだと推測される。また公にしていない以上、今後仕様を変えてくる可能性も考えられる。</p>

<hr>

<p>各プラグインの対応状況</p>

<h3 id="worldeditworldguardpermissionsexessentials">WorldEdit, WorldGuard, PermissionsEx, Essentials</h3>

<p>Guavaのバージョンアップに伴って問題の出る主要プラグインをSpigotチームが独自に配布している。</p>

<h3 id="multiverse">Multiverse</h3>

<p>開発関係者が1.8でも問題ないと発言</p>

<h3 id="dynmap">Dynmap</h3>

<p>dev版が出ている</p>

<h3 id="lockette">Lockette</h3>

<p>前述の看板データ変換問題がある
現行のもので動作は問題ない</p>

<h3 id="blockhat">BlockHat</h3>

<p>現状エラーが出て動かない。
メンテも長らくされてないので今後が怪しい。</p>

<h3 id="playerheads">PlayerHeads</h3>

<p>現状動かないけどそこそこ頻繁にメンテされているのでそのうち対応されると思われる</p>

<h3 id="hawkeye">HawkEye</h3>

<p>エラーは出てないけどブロック増えてる分の挙動は不明</p>
    </div>
</div>

</article>



<nav class="pagination" role="pagination">
   <span class="page-number">Page 1 of 1</span>
</nav>
        </main><!-- #main -->
    </div><!-- #primary -->

    <div id="secondary" class="widget-area" role="complementary">
        <aside class="widget">
            <a class="blog-logo" href="../../"><img src="../../content/images/2015/10/ironingotnet.png" alt="Blog Logo"></a>
            <!--<h3 class="widget-title site-title"><a href="https://www.ironingot.net">ironingot.net</a></h3>-->
            <p class="site-description">minecraft server
</p>
        </aside>

        <aside class="widget" id="sidebar-links">
                <ul id="sidebar-externals">
                    
<!-- <li class="external-link"><a href="https://twitter.com/fubira"><i class="fa fa-twitter"></i></a></li> -->
<li class="external-link"><a href="https://github.com/fubira"><i class="fa fa-github"></i></a></li>
<!-- <li class="external-link"><a href="#"><i class="fa fa-google-plus"></i></a></li> -->
<li class="external-link"><a href="../../rss/index.rss"><i class="fa fa-rss"></i> </a></li>                </ul>
        </aside>

        <footer class="site-footer">
            <div class="site-info">
                <section class="copyright">Theme by <a href="https://diversethemes.com">Diverse Themes</a></section>
                <section class="poweredby">Published with <a href="https://ghost.org">Ghost</a></section>
            </div>
        </footer>
    </div><!-- #secondary -->

    </div><!-- #content -->
</div><!-- #page -->

    

    <script type="text/javascript" src="../../assets/js/jquery.fitvids.js?v=ac1c951ce2"></script>
    <script type="text/javascript" src="../../assets/js/index.js?v=ac1c951ce2"></script>
    <script type="text/javascript" src="../../assets/js/navigation.js?v=ac1c951ce2"></script>

    <!-- jQuery bxslider -->

<!-- Load javascript -->
<script type="text/javascript" src="../../assets/bxslider/jquery.bxslider.min.js?v=ac1c951ce2"></script>

<!-- Link CSS -->
<link href="../../assets/bxslider/jquery.bxslider.min.css?v=ac1c951ce2" rel="stylesheet">

<!-- Initiate instances -->
<script type="text/javascript" src="../../assets/bxslider/options/options.bxslider.js?v=ac1c951ce2"></script>

<!-- jQuery bxslider end -->
</body>
</html>