<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Spigot 1.8.3 + Hawkeye issue</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=ac1c951ce2">
    <link rel="stylesheet" type="text/css" href="../assets/fonts/font-awesome.css?v=ac1c951ce2">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="../assets/js/jquery.ghostHunter.js?v=ac1c951ce2"></script>

    <link rel="canonical" href="index.html">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="ironingot.net">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Spigot 1.8.3 + Hawkeye issue">
    <meta property="og:description" content="鯖をCraftBukkit 1.7.2 -&gt; Spigot 1.8.3 に変えてみたところ案の定いろいろ問題が出たけども、その中で最も危険だった問題点をメモしておく。 1.8.3 への移行直後、Spigot鯖とは別のネットワークに置いてあったMySQL鯖に対してHawkeyeがすごい勢いでクエリを投げはじめ、送りきれないQueueが大量に蓄積されていってサーバが非常に重くなる現象が発生、まともにゲームができなくなってしまった。 取り急ぎHawkeyeの接続先をSpigot鯖のローカルのMySQLに変えたのだけれども、その後しばらく運営していると、サーバの空き容量が激減していることに気づき、いろいろ調べた結果MySQLのデータベースがこんなんなっていた。 root@nagato:/var/lib/mysql# ls -lah   total 80G   drwx------ 10 mysql mysql 4.0K May  7 17:...">
    <meta property="og:url" content="https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/">
    <meta property="article:published_time" content="2015-05-08T17:29:00.000Z">
    <meta property="article:modified_time" content="2015-10-14T17:30:00.878Z">
    <meta property="article:tag" content="Minecraft">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Spigot 1.8.3 + Hawkeye issue">
    <meta name="twitter:description" content="鯖をCraftBukkit 1.7.2 -&gt; Spigot 1.8.3 に変えてみたところ案の定いろいろ問題が出たけども、その中で最も危険だった問題点をメモしておく。 1.8.3 への移行直後、Spigot鯖とは別のネットワークに置いてあったMySQL鯖に対してHawkeyeがすごい勢いでクエリを投げはじめ、送りきれないQueueが大量に蓄積されていってサーバが非常に重くなる現象が発生、まともにゲームができなくなってしまった。 取り急ぎHawkeyeの接続先をSpigot鯖のローカルのMySQLに変えたのだけれども、その後しばらく運営していると、サーバの空き容量が激減していることに気づき、いろいろ調べた結果MySQLのデータベースがこんなんなっていた。 root@nagato:/var/lib/mysql# ls -lah   total 80G   drwx------ 10 mysql mysql 4.0K May  7 17:...">
    <meta name="twitter:url" content="https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "ironingot.net",
    "author": {
        "@type": "Person",
        "name": "fubira",
        "image": "//www.gravatar.com/avatar/6921f11655432d404de3bc8f1c2f1063?s=250&d=mm&r=x",
        "url": "https://www.ironingot.net/author/fubira",
        "sameAs": null,
        "description": null
    },
    "headline": "Spigot 1.8.3 + Hawkeye issue",
    "url": "https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/",
    "datePublished": "2015-05-08T17:29:00.000Z",
    "dateModified": "2015-10-14T17:30:00.878Z",
    "keywords": "Minecraft",
    "description": "鯖をCraftBukkit 1.7.2 -&gt; Spigot 1.8.3 に変えてみたところ案の定いろいろ問題が出たけども、その中で最も危険だった問題点をメモしておく。 1.8.3 への移行直後、Spigot鯖とは別のネットワークに置いてあったMySQL鯖に対してHawkeyeがすごい勢いでクエリを投げはじめ、送りきれないQueueが大量に蓄積されていってサーバが非常に重くなる現象が発生、まともにゲームができなくなってしまった。 取り急ぎHawkeyeの接続先をSpigot鯖のローカルのMySQLに変えたのだけれども、その後しばらく運営していると、サーバの空き容量が激減していることに気づき、いろいろ調べた結果MySQLのデータベースがこんなんなっていた。 root@nagato:/var/lib/mysql# ls -lah   total 80G   drwx------ 10 mysql mysql 4.0K May  7 17:..."
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="ironingot.net" href="../rss/index.html">
</head>
<body class="post-template tag-minecraft">

<div id="page" class="hfeed site">

    <header id="masthead" class="site-header" role="banner">
        <div class="header-wrapper">
            <nav id="site-navigation" class="main-navigation" role="navigation">
                <button class="menu-toggle">Menu</button>
                <ul class="nav">
    <li class="nav-home" role="presentation"><a href="../">HOME</a></li>
    <li class="nav-minecraft-server" role="presentation"><a href="../minecraft-server/">Minecraft Server</a></li>
    <li class="nav-dynmap" role="presentation"><a href="http://dynmap.ironingot.net/">Dynmap</a></li>
    <li class="nav-plugins" role="presentation"><a href="../plugins/">Plugins</a></li>
</ul>
            </nav><!-- #site-navigation -->

            <div id="site-search" class="header-search">
                <div class="header-search-form">
            <form class="search-form">
                <label>
                    <span class="screen-reader-text">Search archives</span>
                    <span class="search-icon">
                    <a href="index.html" class="search-toggle"><span class="screen-reader-text">Search</span></a>
                    </span>
                    <input type="search" id="search-field" class="search-field" placeholder="Search..." value="" name="s" title="Search...">
                </label>
                <input type="submit" class="search-submit" value="search">
            </form>
            </div><!-- #search -->
            </div><!-- #search -->

        </div><!-- .header-wrapper -->

        <!--
        <div class="header-image">
            
        </div>
        -->
        <!-- .header-image -->
    </header><!-- #masthead -->

    <div id="content" class="site-content">

    <div id="primary" class="content-area">
        <main id="main" class="site-main" role="main">
            <section id="results"></section>
                <script>
                    $("#search-field").ghostHunter({
                        results   : "#results"
                    });
                </script>

                

<article class="post tag-minecraft hentry">
<div class="entry-meta">
    <div class="meta-date">20 Oct 2015</div>
    <div></div>
</div>

<div class="content-wrapper">
    <header class="entry-header">
        <h1 class="entry-title">Spigot 1.8.3 + Hawkeye issue</h1>
    </header><!-- .entry-header -->


        <div class="entry-content">
            <p>鯖をCraftBukkit 1.7.2 -&gt; Spigot 1.8.3 に変えてみたところ案の定いろいろ問題が出たけども、その中で最も危険だった問題点をメモしておく。</p>

<p>1.8.3 への移行直後、Spigot鯖とは別のネットワークに置いてあったMySQL鯖に対してHawkeyeがすごい勢いでクエリを投げはじめ、送りきれないQueueが大量に蓄積されていってサーバが非常に重くなる現象が発生、まともにゲームができなくなってしまった。</p>

<p>取り急ぎHawkeyeの接続先をSpigot鯖のローカルのMySQLに変えたのだけれども、その後しばらく運営していると、サーバの空き容量が激減していることに気づき、いろいろ調べた結果MySQLのデータベースがこんなんなっていた。</p>

<pre><code>root@nagato:/var/lib/mysql# ls -lah  
total 80G  
drwx------ 10 mysql mysql 4.0K May  7 17:47 .  
drwxr-xr-x 59 root  root  4.0K Nov  5  2014 ..  
-rw-rw----  1 mysql mysql  80G May  9 02:11 ibdata1
...
</code></pre>

<p><strong>3日前までは合計10MBも使っていなかったようなDBが80GBだと…!?</strong></p>

<p>中身を見ようにもselectするとOutOfMemoryになってしまうような状況なので、Hawkeyeの書き込み先tableを変えて数分動かしてみたところ、秒速3500行、時速にして1260万行のデータがMySQLに送られていることが判明。</p>

<pre><code>|   25077 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25078 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25079 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25080 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25081 | 2015-05-09 01:18:37 |         1 |     28 |        1 | -127 | 61 |  211 | +263:1~1                  |
|   25082 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
|   25083 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
|   25084 | 2015-05-09 01:18:37 |         1 |     28 |        1 |  -84 | 56 |  187 | +17:1~1                   |
...
</code></pre>

<p>これらのデータが何を意味しているかというと、こちら。</p>

<p><img src="../content/images/2015/10/2015-05-09_02-27-12-1024x576.jpg" alt="ホッパー">
<img src="../content/images/2015/10/2015-05-09_02-27-24-1024x576.jpg" alt="中身が詰まった"></p>

<p>接続先が一杯で内容物を移動できないホッパーのchest transaction(28)が大量に記録されていたのだった。1.8になってEventの挙動が変わったのか？</p>

<p>まあホッパー内にある(=運搬するような)アイテムの情報が重要である可能性はほぼないと考えられるので、ホッパーのログをfilterしてしまうことにした。</p>

<h3 id="">対策</h3>

<p>plugins/Hawkeye/config.yml のcontainedtransaction-filter: hopperの部分をfalseに書き換える。</p>

<pre><code>containertransaction-filter:  
  chest: true
  doublechest: true
  furnace: true
  dispenser: true
  hopper: false
  dropper: true
</code></pre>

<p>結果、Hawkeyeのデータ量は15分で800行ぐらい(秒速1行以下)となりました。
めでたしめでたし。</p>

<p>そして肥大化したDBだけが残った。</p>
        </div>

        <footer class="entry-footer post-footer">

            <section class="author">
                <h4>fubira</h4>
                <p></p>
                <ul class="author-meta clearfix">
                    
                    
                </ul>
            </section>

            <section class="share">
                <h4>Share</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Spigot%201.8.3%20%2B%20Hawkeye%20issue&amp;url=https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://www.ironingot.net/spigot-1-8-3-hawkeye-issue/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>

</div>
</article>
        </main><!-- #main -->
    </div><!-- #primary -->

    <div id="secondary" class="widget-area" role="complementary">
        <aside class="widget">
            <a class="blog-logo" href="../"><img src="../content/images/2015/10/ironingotnet.png" alt="Blog Logo"></a>
            <!--<h3 class="widget-title site-title"><a href="https://www.ironingot.net">ironingot.net</a></h3>-->
            <p class="site-description">minecraft server
</p>
        </aside>

        <aside class="widget" id="sidebar-links">
                <ul id="sidebar-externals">
                    
<!-- <li class="external-link"><a href="https://twitter.com/fubira"><i class="fa fa-twitter"></i></a></li> -->
<li class="external-link"><a href="https://github.com/fubira"><i class="fa fa-github"></i></a></li>
<!-- <li class="external-link"><a href="#"><i class="fa fa-google-plus"></i></a></li> -->
<li class="external-link"><a href="../rss/index.rss"><i class="fa fa-rss"></i> </a></li>                </ul>
        </aside>

        <footer class="site-footer">
            <div class="site-info">
                <section class="copyright">Theme by <a href="https://diversethemes.com">Diverse Themes</a></section>
                <section class="poweredby">Published with <a href="https://ghost.org">Ghost</a></section>
            </div>
        </footer>
    </div><!-- #secondary -->

    </div><!-- #content -->
</div><!-- #page -->

    

    <script type="text/javascript" src="../assets/js/jquery.fitvids.js?v=ac1c951ce2"></script>
    <script type="text/javascript" src="../assets/js/index.js?v=ac1c951ce2"></script>
    <script type="text/javascript" src="../assets/js/navigation.js?v=ac1c951ce2"></script>

    <!-- jQuery bxslider -->

<!-- Load javascript -->
<script type="text/javascript" src="../assets/bxslider/jquery.bxslider.min.js?v=ac1c951ce2"></script>

<!-- Link CSS -->
<link href="../assets/bxslider/jquery.bxslider.min.css?v=ac1c951ce2" rel="stylesheet">

<!-- Initiate instances -->
<script type="text/javascript" src="../assets/bxslider/options/options.bxslider.js?v=ac1c951ce2"></script>

<!-- jQuery bxslider end -->
</body>
</html>